<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="./style.css" type="text/css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="key.js"></script>
    <script>
        function start(){
            np = 2941
            var hr = "https://apidata.mos.ru/v1/datasets/"+np+"/rows?api_key="+key;
            $.get(hr, function(data){ 
                data.FullDescription = null
                localStorage.setItem('data', JSON.stringify(data));
            });
            dataset = JSON.parse(localStorage.getItem('data'));
            new_dataset = new Array();
            dmin0 = 100; dmax0=-1;
            wmin0 = 100; wmax0=-1;
            for (i=0; i<dataset.length; i++){
                name = dataset[i].Cells.Name;
                coords = dataset[i].Cells.geoData.coordinates;
                if (coords[1] < wmin0){
                    wmin0 = coords[1];
                }
                if (coords[1] > wmax0){
                    wmax0 = coords[1];
                }
                if (coords[0] < dmin0){
                    dmin0 = coords[0];
                }
                if (coords[0] > dmax0){
                    dmax0 = coords[0];
                }
                new_dataset.push({'Name': name, 'Coords': coords})
            }
            dd = dmax0-dmin0  // по X
            wd = wmax0-wmin0; // по Y
            kw = 10000/90;  // км/градус по меридиану 
            wkm = wd*kw  	// север-юг 42 км 
            kd = kw*Math.cos(((wmax0+wmin0)/2)*Math.PI/180) // км/градус по параллели 
            dkm = kd*dd     // восток-запад в км  32
            kkm = dkm/wkm   // пропорция прям-ка (<1)  
            ymax = 400; xmax = Math.round(ymax * kkm);
            ky = ymax/(wmax0-wmin0); kx=xmax/(dmax0-dmin0)
            function kY(w){return -Math.round(ky*(w-wmin0))} // широта
            function kX(d){return Math.round(kx*(d-dmin0))} // долгота
            var canvas = document.getElementById("canvas");
            var cnt1 = canvas.getContext("2d");
            cnt1.setTransform(1, 0, 0, 1, 0, 0);
            cnt1.clearRect(0, 0, canvas.width, canvas.height);
            coords = new Array();
            with (cnt1){
                translate(0,ymax);
                strokeStyle = "#F00";
                for (var i=0;i<new_dataset.length;i++){
                    p = new_dataset[i].Coords; 
                    x = kX(p[0]); y = kY(p[1]);
                    coords.push({'x': x, 'y': y})
                    beginPath()
                        cnt1.arc(x,y, 2, 0, Math.PI*2);
                    stroke()
                }
                
            }
            maxx = -1;
            minx = 100000;
            y_list = new Array();
            for(i=0; i<coords.length; i++){
                y_list.push(coords[i].y);
                if (coords[i].x < minx){
                    minx = coords[i].x;
                }
                if (coords[i].x > maxx){
                    maxx = coords[i].x;
                }
            }
            y_list.sort();
            med = y_list[Math.round((y_list.length + 1) / 2)]
            with (cnt1){
                strokeStyle = "#000";
                beginPath()
                moveTo(minx, med);
                lineTo(maxx, med);
                stroke();
            }   
            cnt1.translate(0,-ymax);
        }

        function rand(){
            var canvas = document.getElementById("canvas");
            var cnt1 = canvas.getContext("2d");
            cnt1.setTransform(1, 0, 0, 1, 0, 0);
            cnt1.clearRect(0, 0, canvas.width, canvas.height);
            coords = new Array();
            with (cnt1){
                strokeStyle = "#F00";
                for (var i=0;i<2000;i++){
                    x = Math.floor(Math.random() * canvas.width); y = Math.floor(Math.random() * canvas.height);
                    coords.push({'x': x, 'y': y})
                    beginPath()
                        cnt1.arc(x,y, 2, 0, Math.PI*2);
                    stroke()
                }
                
            }
            maxx = -1;
            minx = 100000;
            y_list = new Array();
            for(i=0; i<coords.length; i++){
                y_list.push(coords[i].y);
                if (coords[i].x < minx){
                    minx = coords[i].x;
                }
                if (coords[i].x > maxx){
                    maxx = coords[i].x;
                }
            }
            y_list.sort();
            med = y_list[Math.round((y_list.length) / 2)]
            with (cnt1){
                strokeStyle = "#000";
                beginPath()
                moveTo(minx, med);
                lineTo(maxx, med);
                stroke();
            }
        }
    </script>
</head>
<body>
    <p align="center">Выполнил студент группы ПИ19-2 Бедак Иван</p>
    <p align="center">Гео-данные Объектов строительства</p>
    <table border cellspacing=0 cellpadding=5 align='center'>
        <tr><td valign='top'>

        <td valign=top>
            <canvas id="canvas" width="400" height="400"></canvas>
        <td valign='top'><p><input type='button' value='Рандомные точки' onclick='rand()'>
            <input type='button' value='Объекты строительства' onclick='start()'>
            <p>разделяет горизонтальной прямой множество точек так, чтобы по разные стороны от нее было равное число точек;</p>
            </p>
    </table>
</body>
</html>